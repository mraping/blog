# 数据搜索核心原理

# 系统架构设计需求
千亿级数据实时搜索，要满足如下要求:

- 高并发，要能支持百万级以上并发
- 实时性，响应时间不超过3秒

# 方案分析
## 用数据库是否可以?
Mysql、pgSql、DB2、Oracle

## 数据库为何不能分析

常用的数据库优化方法:

- 建索引
- 分区表

建索引对like查询没有效果，为什么？

## 索引的原理是怎样的? 

> 对列值创建排序存储，数据结构={列值、行地址}。在有序数据列表中就可以利用
二分查找快速找到要查找的行的地址，再根据地址直接取行数据。

使用红黑树，可以做到深度平衡

## 索引的排序，是怎么排的?

- 数值列
- 时间列
- 文本列

## 如果要对查询出来的结果进行相关度排名,数据库能否做到?

如:要查询苍老师、tony、 火锅有关的新闻:

含有三个关键字(相关度最高)的新闻排前面</br>
含两个关键字(相关度次之)，排次之</br>
含一个关键字的，排次次之。</br>

如果要对搜索的新闻字段设置不同的权重，比如新闻标题中包含这三个关键字的新闻的
相关性就远高于新闻内容中包含这三个字。数据库能否做到?

**结论:数据库适合结构化数据的精确查询，而不适合半结构化、非结构化数据的模
糊查询及灵活搜索(特别是数据量大时)， 无法提供想要的实时性。**

- 结构化数据:用表、字段表示的数据
- 半结构化数据:xml html
- 非结构化数据:文本、 文档、图片、音频、视频等

# 搜索引擎核心原理一反向索引
## 为什么称为倒排索引?
英文原名Inverted index,失败地被翻译成了倒排索引。
而应该翻译为:反向索引

查询一篇文章包含哪些关键词，
需要怎样的索引?(文章 --> 词)
文章id | 包含的关键词
---|---
1 | {tony,苍火锅，老师}
2 | {火锅,四}


查询哪些文章包含某关键词，需要怎样的索引?(词 --> 文章 )
词 | 包含该词的文章id
---|---
tony | {1,2}
苍 | {1,9}
火锅 | {1,8,9}
老师 | {1,9}

## 反向索引的记录数会不会很大?
- 如果是英文的，最大是多少?
- 如果是中文的，最大可能是多少?

英语单词的大致数量是10万个

汉字的总数已经超过了8万，而常用的只有3500字
《现代汉语规范词典》比《现代汉语词典》收录的字和词数量更多。前者是13000多字,
72000多词，后者是11000多字，69000多词

**结论:量不会很大，100万以内;通过这个索引找文章会很快。**

## 如何建立这样一个索引?
数据示例</br>
新闻id: 1</br>
新闻标题: Tony 与苍老师一起吃火锅</br>
新闻内容: 2018年4月1日，Tony 在四川成都出席某活动时，碰巧主办方也邀请了苍老师来提↓
高人气，在主办方的邀请下和苍老师一起吃了个火锅，很爽!

怎样为上面的新闻文章建立反向索引?一句话怎么分成多个词?人能分，计算机能不能分?

# 搜索引擎核心原理一 分词器

## 如果要开发一个中文分词器，你觉得该怎么实现对一句话进行分词?
语句示例:张三说的确实在理。

分析

机器不会分，而我们人会分。</br>

问1:我们人是怎么分的?</br>
从头开始一个-个字读,通过前后字的组合,分出:张三、说的、确实、在理

问2:我们是怎么确定张三、说的、确实是词?</br>
因为我们的大脑里有个词的字典,通过与字典匹配，而确定。

问3:为什么我们不会分出:张三、说的、的确、确实、实在、在理?</br>
因为我们的大脑可以进行歧义分析。

**中文分词器原理:有个词的字典，对语句前后字进行组合，与字典匹配，歧义分析**

## java开源中文分词器有哪些?
中文分词器有很多，如何选择?

- 准确率
- 分词效率
- 中英文混合分词支持

常用中文分词器:
lKAnalyzer mmseg4j

# 搜索引擎核心原理一搜索
步骤1:对搜索输入进行分词
tony、苍老师

步骤2:在反向索引中找出包含tony、苍老师的文章列表

tony | {{1,1,{0}},{12,1,{5}}} | {{1,1,{11},{8,1,{90}}}
---|---|---
苍老师 | {{1,1,{6}}}| {{1,2,{21,32}},{5,3,{18,29,45}}}

步骤3:合并两个列表， 排序输出
{1,12,8,5}

# 搜索引擎核心原理-相关性计算模型

规则1:统计出现次数,根据次数从高到低排

规则2:加入权重，标题权重10,内容权重1，计算权重得分，按高-低排序

复杂的相关性计算模型有:

- tf-idf 词频-逆文档率模型
- 向量空间模型
- 贝叶斯概率模型，如: BM25 

搜索引擎中会提供一种、或多种实现供选择使用，也会提供扩展。

# JAVA开源搜索引擎
java领域应用广泛的开源搜索引擎组件、系统:Nutch、Solr、Elasticsearch..

## Lucene
 Apache顶级开源项目，Lucene-core是 一个 开放源代码的全文检索引擎工具包，但它不
是一个完整的全文检索引擎，而是一个全文检索引擎的框架，提供了完整的查询引l擎和索引引擎，
部分文本分词引擎(英文、德文等西方语言)。Lucene的目的是为软件开发人员提供一个简单易
用的工具包，以方便的在目标系统中实现全文检索的功能，或者是以此为基础建立起完整的全文
检索引擎。

## Nutch
 Apache顶级开源项目，包含网络爬虫和搜索引擎(基于lucene)的系统(同百度、google)
Hadoop因它而生。

## Solr
Lucene下的子项目，基于Lucene构建的独立的企业级开源搜索平台，一个服务。它提供了
基于xml/JSON/http的api供外界访问，还有web管理界面。

## Elasticsearch
基于Lucene的企业级分布式搜索平台，它对外提供restful-web接口，让程序员
可以轻松、方便使用搜索平台，而不需要了解Lucene。
