千万级并发架构优化策略 - 限流
## 高并发的技术方案
扩容、动静分离、缓存、服务降级与熔断、限流
## 限流
系统的访问量一旦达到阈值，就采用一些措施进行限制。</br>
例如：延迟处理、部分处理、部分拒绝处理
## 限流的层面
- 接入层限流
- 应用层限流

![](http://39.96.200.64/upload/2019/02/0lutura1oegctr9f7j824phee7.png)
## 限流算法
### 计数器算法

计数器算法是先限流算法中最简单、最容易实现的算法

算法缺点：临界问题

![](http://39.96.200.64/upload/2019/02/7vq5jd1umeik5oai982hbvdfh0.png)
### 令牌桶算法

#### 场景
- 系统每秒向桶里放入5个令牌
- 桶的容量是5，如果桶已经满了，令牌被丢弃
- 系统处理请求时，需先从桶中拿到一个令牌，然后进行处理
- 如果令牌桶中没有令牌，则该请求被限制（流量干预）

#### 特点
- 缓冲区

比如桶中有5个令牌，那么第一秒可以处理的请求为10，后续的请求会趋于每秒5个

- 允许并发	

请求处理时可以拿到一个令牌，也可以拿到多个令牌

![](http://39.96.200.64/upload/2019/02/2phechrgv8je2p1l46uiph879q.png)

#### 实际开发的应用
- 限流的层面

应用层限流（接口Controller）

- 开源框架

Guava框架的RateLimter类

![](http://39.96.200.64/upload/2019/02/45ci3udm58i51orqb1o0paft80.png)

## 分布式下的应用限流难点
### 分布式限流难点
- 应用部署有多台，需要全局限流
- 负载均衡不一定能够”雨露均沾“

### 关键解决方案
- 一个全局的”计数器“或者”桶“
- 把限流处理做成原子化

## 分布式场景下的限流技术方案
### 全局计数器-Redis
- 基于键值对（Key-Value）的内存数据库
- 提供键过期时间（限制时间）
- 单线程模型

### 操作原子性-Lua脚本
提供限流服务的原子性

### 实现方案
Redis集合Lua实现分布式场景下的限流
- 分布式场景
- 应用级别（接口）
- 限流算法（计数器）：限制一分钟访问10次

![](http://39.96.200.64/upload/2019/02/460r0bgfiojf0ooh6lthfkiklr.png)

## 对于限流技术的总结
- 京东的抢购业务就是使用的Redis+Lua
- 优雅的实现可以使用AOP
- 实际问题实际分析，要考虑成本！

## 高并发高可用系统中的开源技术框架
- 高并发分流框架：Nginx
- 分布式环境指挥官：Zookeeper
- 异步与消息中间件：MQ、Kafka
- 搞笑缓存与NoSQL：Redis、MongoDB
- 高可靠数据存储：分库分表、FastDFS
