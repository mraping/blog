## 定义
将持久化的数据存放在内存副本中，用以提高并发，提高读取速度（主要是以下原因）

1. 基于内存操作
2. 空间换时间
3. 降低瓶颈操作
4. 减少对外依赖

## 提高系统并发的方式
1. 缓存
2. 异步

## 什么数据适合缓存
1. 高频
2. 相对稳定

有选择的缓存，并且要设置恰当的缓存时效

## 分布式应用缓存
[]()

Redis是完全可以取代Memcached的

## 缓存架构
![](http://39.96.200.64/upload/2019/02/7el8jqmno2g2gq2q162tnpd8nv.jpeg) 

## 性能指标
![](http://39.96.200.64/upload/2019/02/qu7bs4ommchr2p5lh9fmglm36c.jpeg)

## 本地缓存与分布式缓存的对比
![](http://39.96.200.64/upload/2019/02/p6ieoiab78i17ofgq8f8bemqlg.jpeg)

## 本地应用缓存
![](http://39.96.200.64/upload/2019/02/stkuhd4b0ug5nra9ba25ke9t2u.jpeg)

SpringBoot2.0 干掉了guava，推介使用coffeine
coffeine 相比 guava效率高的原因：更新了缓存算法，但是要求jdk版本最低为1.8


## 分布式应用缓存
![](http://39.96.200.64/upload/2019/02/sl42483l8uhkkp2bf7rococ2bd.jpeg)

## 大型互联网企业如何选择缓存
![](http://39.96.200.64/upload/2019/02/36t22iu8c8j3uop14qktij1imt.jpeg)

## Spring Cache原理
AOP 
进方法（before） 
出方法（after）


## 三秒定理
打开一个应用或者网页大多数能忍受的时间为3s

## 304状态码
如果客户端发送了一个带条件的GET 请求且该请求已被允许，而文档的内容（自上次访问以来或者根据请求的条件）并没有改变，则服务器应当返回这个304状态码。简单的表达就是：客户端已经执行了GET，但文件未变化。



百亿交易额背后的缓存架构-高并发分布式

## 数据库性能

- TPS:Transaction Per Second,数据库每秒执行的事
  务数，以commit为准。
- QPS:Query Per Second,数据库每秒执行的SQL数
  (含insert、select、 update、 delete等) 。

### 数据库查询缓存

- 缓存整个sql（缓存性能差）
- mysql5.7不推介使用缓存，mysql8.0直接抛弃
- 默认不开启数据库缓存
- 查看查询缓存状态：

```
SHOW VARIABLES LIKE '8query_cache8' ;
```

### 缓存性能衡量指标：

- 命中率
- 维护成本

## 推介使用应用层缓存

Java应用会读数据库，把数据缓存起来，是本地缓存（如Map等），不同的进程无法访问，也不好维护。因此出现了分布式缓存中间件（Redis、Memcached）

| 比较项   | 单机缓存                                                     | 分布式缓存中间件                                           |
| -------- | ------------------------------------------------------------ | ---------------------------------------------------------- |
| 运行方式 | 嵌入单一进程内部的存储区域                                   | 独立启动的进程                                             |
| 交互方式 | 通过内存直接访问                                             | 通过网络进行交互                                           |
| 读取速度 | 纳秒级别                                                     | 毫秒级别                                                   |
| 实现     | HashMap、Guava、 Ehcache..                                   | Redis、Memcached..                                         |
| 优缺点   | 速度最快。只能单进程使用，同样的数据存储到速度快，多进程共用，节省内存占 | 不同的进程，导致缓存维护成本高内存占用率高用和缓存维护成本 |

## redis

基于内存亦可持久化的日志型、Key-Value数据库，每秒处理请求几十万(常用来做数据缓存)

| 入门阶段                                                     | 进阶                                                         | 实战应用                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Redis概念命令及简单使用，多种持久化的配置，使用主从实现读写分离，结合Spring或其他客户端搭建哨兵实现高可用发布订阅等机制的使用 | 主从数据同步延迟问题，不同数据类型的应用场景，持久化过程中消息丢失，Cluster集群及性能分析，哨兵高可用原理深度剖析，不同持久化方式的优缺点 | 亿级数据存储、缓存击穿/雪崩解决方案、电商系统超时订单实现、Redis高性能原理分析、分布式订单号生成、基于redis实现的分布式锁 |

## 代理服务器缓存

- JAVA应用程序请求nginx，Nginx内无缓存，则访问后端JAVA程序
- 会在ngnix的缓存文件夹下面生成缓存文件
- 访问的是nginx，nginx是不做处理的，收到请求之后会转发给java服务器
- nginx进程：nginx可配置工作进程数，另外还有一个监控进程



## 面试题 项目中缓存是如何使用的？为什么要用缓存？缓存使用不当会造成什么后果？

## 面试官心理分析

这个问题，互联网公司必问，要是一个人连缓存都不太清楚，那确实比较尴尬。

只要问到缓存，上来第一个问题，肯定是先问问你项目哪里用了缓存？为啥要用？不用行不行？如果用了以后可能会有什么不良的后果？

这就是看看你对缓存这个东西背后有没有思考，如果你就是傻乎乎的瞎用，没法给面试官一个合理的解答，那面试官对你印象肯定不太好，觉得你平时思考太少，就知道干活儿。

## 面试题剖析

### 项目中缓存是如何使用的？

这个，需要结合自己项目的业务来。

### 为什么要用缓存？

用缓存，主要有两个用途：**高性能**、**高并发**。

#### 高性能

假设这么个场景，你有个操作，一个请求过来，吭哧吭哧你各种乱七八糟操作 mysql，半天查出来一个结果，耗时 600ms。但是这个结果可能接下来几个小时都不会变了，或者变了也可以不用立即反馈给用户。那么此时咋办？

缓存啊，折腾 600ms 查出来的结果，扔缓存里，一个 key 对应一个 value，下次再有人查，别走 mysql 折腾 600ms 了，直接从缓存里，通过一个 key 查出来一个 value，2ms 搞定。性能提升 300 倍。

就是说对于一些需要复杂操作耗时查出来的结果，且确定后面不怎么变化，但是有很多读请求，那么直接将查询出来的结果放在缓存中，后面直接读缓存就好。

#### 高并发

mysql 这么重的数据库，压根儿设计不是让你玩儿高并发的，虽然也可以玩儿，但是天然支持不好。mysql 单机支撑到 `2000QPS` 也开始容易报警了。

所以要是你有个系统，高峰期一秒钟过来的请求有 1万，那一个 mysql 单机绝对会死掉。你这个时候就只能上缓存，把很多数据放缓存，别放 mysql。缓存功能简单，说白了就是 `key-value` 式操作，单机支撑的并发量轻松一秒几万十几万，支撑高并发 so easy。单机承载并发量是 mysql 单机的几十倍。

> 缓存是走内存的，内存天然就支撑高并发。

### 用了缓存之后会有什么不良后果？

常见的缓存问题有以下几个：

- [缓存与数据库双写不一致](/docs/high-concurrency/redis-consistence.md)
- [缓存雪崩、缓存穿透](/docs/high-concurrency/redis-caching-avalanche-and-caching-penetration.md)
- [缓存并发竞争](/docs/high-concurrency/redis-cas.md)

后面再详细说明。