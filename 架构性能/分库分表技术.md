# 大型互联网系统数据存储处理难题分析
## 我们使用数据库来存储数据常会碰到哪些问题?
### 查询慢
查询慢的原因可能是什么?

- 数据量大
- 数据库太忙

查询慢的常规处理办法有哪些?
- 建索引
- 优化SQL
- 缓存

### 常规处理办法能缓解数据库的写压力吗?  [不能]

### 并发读写的压力超出了数据库的承受能力，我们怎么办?
#### 对于读压力，我们可以想什么办法?
- 集群，多个从库.

思考:此时数据库中间件需要具备什么能力?
- 负载均衡

#### 对于写压力呢?

能集群，多个主库吗? [不能]

因为主库集群并不能解决并发写压力。

解决方案：
- 分库（按业务模块分成多个数据库，分散压力）

#### 数据量很大，并发压力很大:分库+读写分离


### Mysq|的并发能力如何?
可以搜索查看 [阿里云-RDS版Mysql性能测试结果](https://help.aliyun.com/document_detail/109376.html?spm=a2c4g.11186623.6.1244.79622298tdCnux)

常规的8核16G：

- 连接数：4000
- IOPS：8000
- TPS：982
- QPS：20879


# 数据库中间件
如果单个表的数量很大，超出了单表的存储上限，如电商网站的商品表、订单表等。
分区表、分表

如何分?

根据一定规则将数据分到多个表中存储
- 可以有怎样的分表规则?
- 分表的情况下，对DAO层数据访问有影响吗?
- 如何决定数据存储到哪个表?
- 如何查询多个表?
- 如何做到对DAO层透明?

> 以上问题都可以交给数据库中间件来解决

为解决数据存储、访问问题我们需要分布式数据库、数据库中间件</br>
数据库中间件让我们可以在应用程序中快速应用读写分离、分布式数据库!

## 数据库中间件的两种实现模式
### 客户端模式
在应用程序中集成数据库中间件模块，通过该模块来配置管理应用需要
的一个(或者多个)数据源，以及访问各个数据源，在模块内完成数据的整合。

### 服务端(代理)模式
通过中间代理层来统一管理所有的数据源，后端数据库集群对
前端应用程序透明，同时易于数据库扩展。独立的服务能提供更强的处理能力。适用
于大型复杂系统。

## 常用数据库中间件

### 客户端模式
1. 当当：sharding-jdbc
2. 阿里：TDDL

### proxy
1. 社区:Mycat-cobar
2. 数字:Atlas
3. 百度:heinsberge
4. youtube:vitess 
5. 金山:kingshard
6. 商业版:Oneproxy


# 数据库拆分方式
## 垂直拆分
按业务模块垂直拆分

### 优点:
- 拆分后业务清晰，拆分规则明确;
- 系统之间整合或扩展容易;
- 数据维护简单。
### 缺点:
- 部分业务表无法join，只能通过接口方式解
决，提高了系统复杂度;
- 受每种业务不同的限制存在单库性能瓶颈,
不易数据扩展跟性能提高;
- 事务处理复杂。

### 表级垂直拆分
对很多列的表进行垂直拆分

## 水平拆分
### 优点:
- 拆分规则抽象好，join 操作基本可以数据库做;
- 不存在单库大数据，高并发的性能瓶颈;
- 应用端改造较少;
- 提高了系统的稳定性跟负载能力。

### 缺点:
- 拆分规则难以抽象;
- 分片事务一致性难以解决;
- 数据多次扩展难度跟维护量极大;
- 跨库join性能较差。

# Sharding-JDBC
数据分片内核工作原理

SQL解析=>执行器优化=> SQL路由=> SQL改写=> SQL执行=>结果归并的流程组成

# Mycat
Mycat高可用方案:HAproxy + keepalive + Mycat高可用负载均衡集群

Mycat集群配置zookeeper化
